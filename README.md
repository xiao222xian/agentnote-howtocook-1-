# RAG 菜谱系统学习笔记
本仓库为 RAG 菜谱系统的完整学习笔记，涵盖**环境配置、数据准备、索引构建、检索优化、生成集成与系统整合**五大核心模块，梳理了各模块核心设计、流程逻辑、关键技术及系统整体联动架构，基于 LangChain 生态开发，核心实现「小块检索、大块生成」的高效 RAG 问答能力。

## 目录
- [1. 环境配置](#1-环境配置)
- [2. 数据准备模块](#2-数据准备模块)
- [3. 索引构建模块（IndexConstructionModule）](#3-索引构建模块-indexconstructionmodule)
- [4. 检索优化模块（RetrievalOptimizationModule）](#4-检索优化模块-retrievaloptimizationmodule)
- [5. 生成集成与系统整合模块](#5-生成集成与系统整合模块)

## 1. 环境配置
快速搭建运行环境，核心三步完成初始化：
1. 拉取项目代码
2. 安装项目依赖环境
3. 配置月之暗面 Kimi API 密钥（MOONSHOT_API_KEY）

## 2. 数据准备模块
### 核心定位
实现**「小块检索，大块生成」**的父子文本块架构，为后续检索和生成提供结构化、关联化的文本数据与元数据，是整个 RAG 系统的数据基础。

### 整体流程
```
初始化模块（传入数据路径）→ load_documents（加载文件→生成父文档→自动提取元数据）→ chunk_documents（结构化分块→生成子块→建立父子关联）→ 向上层输出（父文档/子块/元数据/统计信息）
```

### 父子文本块映射关系
父文档为完整菜谱，子块按菜谱结构结构化拆分，实现精准检索与完整生成的结合：
```
父文档（完整菜谱）
├── 子块1：菜品介绍 + 难度评级
├── 子块2：必备原料和工具
├── 子块3：计算（用量配比）
├── 子块4：操作（制作步骤）
└── 子块5：附加内容（变化做法）
```
**示例（西红柿炒鸡蛋）**：
```
原文档：西红柿炒鸡蛋的做法.md (父文档)
├── 子块1：# 西红柿炒鸡蛋的做法 + 简介 + 难度评级
├── 子块2：## 必备原料和工具 + 食材清单
├── 子块3：## 计算 + 用量配比公式
├── 子块4：## 操作 + 详细制作步骤
└── 子块5：## 附加内容
```

### 核心工作逻辑
1. **检索阶段**：使用小的子块进行精确匹配，提升检索准确性和效率
2. **生成阶段**：传递完整的父文档给 LLM，确保生成上下文的完整性
3. **智能去重**：检索到同一道菜的多个子块时，自动合并为一个完整菜谱，避免重复生成

### 元数据增强（自动提取，无人工标注）
从文件路径/名称/内容中自动提取元数据，为精准过滤检索提供支撑：
- 菜品分类：从文件路径推断（荤菜、素菜、汤品等）
- 难度等级：从内容中的星级标记提取
- 菜品名称：从文件名直接提取
- 文档关系：建立父子文档的唯一 ID 映射关系

## 3. 索引构建模块（IndexConstructionModule）
### 核心定位
将文本块转换为计算机可理解的**语义向量**，构建高效的向量检索索引，是实现「向量检索（理解语义、匹配用户意图）」的关键环节，为检索层提供核心的语义匹配能力。

### 核心设计
#### 3.1 技术选型
- 嵌入模型：**BAAI/bge-small-zh-v1.5**（轻量高效，适配中文语义理解）
- 向量数据库：**FAISS**（高效的开源向量检索库，支持毫秒级相似度匹配）
- 核心优化：**索引缓存机制**（首次构建后本地保存，后续启动直接加载，启动时间从分钟级缩短至秒级）

#### 3.2 混合检索基础
为检索优化模块提供基础能力，后续结合 BM25 关键词检索，通过 RRF 算法融合结果，兼顾语义与精准匹配。

### 核心运行流程
```
初始化配置 → 加载嵌入模型 → 优先加载本地索引 → 提供检索能力
```
1. **初始化模块**：指定嵌入模型（默认 BAAI/bge-small-zh-v1.5）和索引本地保存路径（默认 `./vector_index`）；
2. **自动加载嵌入模型**：完成文本→语义向量的编码工具初始化，为后续向量化做准备；
3. **上层模块调用 load_index**：优先尝试加载本地已保存的向量索引；
   - 加载成功：直接获取 FAISS 向量存储对象（vectorstore），具备语义相似度检索能力；
   - 加载失败/索引路径不存在：调用 build_vector_index，传入数据准备模块的结构化子块文档，通过嵌入模型编码为向量并构建新 FAISS 索引，构建完成后调用 save_index 保存到本地，最终获得 vectorstore 并提供检索能力。

### 核心本质
通过 **「预加载嵌入模型 + 优先复用本地索引」**，高效构建/复用向量索引，为 RAG 系统提供「理解语义、模糊匹配」的核心检索支撑。

## 4. 检索优化模块（RetrievalOptimizationModule）
### 核心定位
RAG 系统**检索精度的核心优化层**，是连接索引构建模块和生成集成模块的关键桥梁。核心职责是整合向量语义检索和 BM25 关键词检索的优势，通过 RRF 算法重排实现混合检索，并支持元数据精准过滤，解决单一检索的局限性，为生成模块提供更精准、贴合用户意图的菜谱子块文档。

### 核心能力
基于 LangChain 生态开发，实现三大核心能力：**双检索器初始化、混合检索+RRF 重排、元数据过滤检索**。

### 核心运行流程
```
初始化模块（注入FAISS向量库+子块文档）→ 自动设置向量/BM25双检索器 → 对外提供检索能力
├─ 基础检索需求 → 调用hybrid_search（双检索→RRF重排→返回顶k结果）；
└─ 带条件检索需求 → 调用metadata_filtered_search（混合检索扩大候选→元数据精准过滤→返回顶k结果）。
```

### 关键技术：RRF 算法（倒数排名融合）
#### 核心思想
文档在单个检索结果中的排名越靠前，其最终融合分数越高；通过倒数排名的方式，将向量检索和 BM25 检索两个独立的排名融合为一个综合排名，避免过度依赖单一检索方式，无人工权重设置，无监督更高效。

#### 核心公式
单个检索结果中，某文档的 RRF 分数 = `1 / (k + rank)`
- `k`：平滑参数（通用经验值 60，避免排名为 0 时分母为 0）
- `rank`：文档在该检索结果中的排名（从 0 开始计数）
- 最终分数：文档在向量检索和 BM25 检索中的 RRF 分数之和，分数越高综合排名越靠前。

### 双检索器互补优势
| 检索器类型 | 核心原理 | 优势 | 适用场景 |
|------------|----------|------|----------|
| 向量检索器 | 语义向量相似度匹配 | 理解用户查询意图，支持模糊查询 | 自然语言模糊查询、意图类问题（如“适合新手的简单菜”） |
| BM25 检索器 | 词频-逆文档频率关键词匹配 | 关键词精准匹配，检索速度快 | 明确菜品名、术语查询（如“宫保鸡丁怎么做”） |

## 5. 生成集成与系统整合模块
### 生成集成模块
#### 核心定位
整个 RAG 系统的**「大脑」**，是连接检索结果和用户最终体验的核心模块。核心职责是集成大语言模型（LLM），基于检索优化模块返回的高相关性菜谱文档，结合定制化提示词（Prompt）和 LangChain 表达式语言（LCEL），为用户生成贴合查询意图、格式规范、实用性强的烹饪相关回答，同时提供查询重写、查询路由、流式输出等增强能力。

#### 技术选型
- 基础框架：LangChain 生态
- LLM 模型：月之暗面（Moonshot）Kimi 大模型
- 核心能力：LLM 初始化、多类型回答生成、智能查询处理、流式输出

#### 核心设计思路
1. **智能查询路由**：根据用户查询自动分类为「list（列表推荐）、detail（详细制作）、general（一般问题）」，选择最适配的生成策略；
2. **查询重写优化**：对模糊、宽泛、口语化查询进行智能重写，提升检索效果（如“做菜”→“简单易做的家常菜谱”）；
3. **多模式生成**：
   - 列表模式：适用于推荐类查询，返回简洁的菜品列表（无冗余，直接提取元数据）
   - 详细模式：适用于制作类查询，提供分步骤的结构化详细指导（含菜品介绍、食材、步骤、技巧）
   - 基础模式：适用于一般性问题，提供精准、实用的常规回答。

### 系统整合模块
#### 核心定位
负责**协调各个模块联动**，实现完整的 RAG 端到端流程，同时提供索引缓存、交互式问答等实用功能，是整个系统的「总指挥」。

#### 核心设计与流程
1. **主系统类设计**：封装各模块实例，统一对外提供接口；
2. **系统初始化流程**：依次初始化「数据准备模块→索引构建模块→生成集成模块」，完成全链路能力加载；
3. **知识库构建流程**：基于数据准备模块生成的结构化数据，构建并缓存向量索引，完成知识库初始化；
4. **智能问答全流程**：
   ```
   接收用户查询 → 智能路由 → 查询优化（重写）→ 混合检索 → 父子文档处理（子块检索→父文档提取）→ 多模式生成（list/detail/basic）→ 输出回答
   ```
5. **交互式问答**：支持用户连续提问，保持会话上下文，提升使用体验。

### 系统整体联动架构
```
用户查询 → 生成集成模块（查询重写+路由）→ 检索优化模块（混合检索+RRF重排+元数据过滤）→ 索引构建模块（向量相似度匹配）→ 数据准备模块（子块检索→父文档提取）→ 生成集成模块（多模式生成）→ 向用户输出回答
```